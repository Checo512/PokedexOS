<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <title>RotomDex OS v2.1.1</title>
    <link rel="icon" type="image/png" href="https://www.pokewiki.de/images/archive/9/91/20221120171746%21Smart-Rotom_Artwork_KAPU.png">
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Rajdhani:wght@500;600;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

    <!-- LIBRERÍAS FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root {
            /* Colores */
            --rotom-red: #ff3b3b;
            --bezel-gray: #151515;
            --neon-blue: #00f3ff;
            --neon-orange: #ff9d00;
            --glass-bg: rgba(10, 20, 30, 0.85);
            --font-main: 'Rajdhani', sans-serif;
            --font-mono: 'Share Tech Mono', monospace;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; scrollbar-width: none; -webkit-tap-highlight-color: transparent; }
        ::-webkit-scrollbar { display: none; }

        body {
            background-color: #050505;
            color: white;
            font-family: var(--font-main);
            height: 100vh;
            height: 100dvh; 
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            background-image: radial-gradient(#222 1px, transparent 1px);
            background-size: 30px 30px;
        }

        /* --- CARCASA ROTOM (RESPONSIVE) --- */
        .rotom-chassis {
            position: relative;
            width: 96vw; height: 96vh;
            max-width: 1800px;
            background-color: var(--rotom-red);
            border-radius: 30px;
            box-shadow: 
                inset 5px 5px 15px rgba(255,255,255,0.3),
                inset -5px -5px 20px rgba(0,0,0,0.5),
                0 0 60px rgba(255, 59, 59, 0.2);
            padding: 15px;
            display: flex; flex-direction: column;
            z-index: 10;
            transition: all 0.3s ease;
        }

        .screen-bezel {
            width: 100%; height: 100%;
            background: var(--bezel-gray);
            border-radius: 20px;
            padding: 10px;
            box-shadow: inset 0 0 20px black;
            position: relative; overflow: hidden;
            display: flex; flex-direction: column;
        }
        
        .rotom-camera {
            position: absolute; top: 12px; left: 50%; transform: translateX(-50%);
            width: 10px; height: 10px; background: #000; border-radius: 50%;
            border: 1px solid #444; z-index: 60;
            box-shadow: 0 0 5px rgba(0,243,255,0.8);
        }

        /* --- PANTALLA DIGITAL --- */
        .screen-display {
            width: 100%; height: 100%;
            background: radial-gradient(circle at center, #111a26 0%, #000 100%);
            border-radius: 12px;
            position: relative; overflow: hidden;
            border: 1px solid #333;
            display: flex; flex-direction: column;
        }

        .screen-display::after {
            content: ''; position: absolute; inset: 0;
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.1) 50%);
            background-size: 100% 4px; pointer-events: none; z-index: 5; opacity: 0.5;
        }

        /* --- UI HEADER --- */
        .ui-header {
            height: 70px; flex-shrink: 0;
            display: flex; align-items: center; justify-content: center;
            background: rgba(0,0,0,0.8); border-bottom: 1px solid var(--neon-blue);
            padding: 0 20px; position: relative; z-index: 50; 
        }

        .search-bar-container {
            position: relative; width: 50%; min-width: 300px;
            background: rgba(0, 20, 40, 0.9);
            border: 1px solid var(--neon-blue);
            border-radius: 30px; display: flex; align-items: center;
            padding: 8px 20px;
            box-shadow: 0 0 15px rgba(0, 243, 255, 0.1);
            transition: box-shadow 0.3s;
        }
        .search-bar-container:focus-within { box-shadow: 0 0 25px rgba(0, 243, 255, 0.4); }

        .search-input {
            flex-grow: 1; background: transparent; border: none;
            color: white; font-family: var(--font-main); font-size: 1.3rem;
            font-weight: 600; text-transform: uppercase; letter-spacing: 1px; outline: none;
            text-align: center; 
        }
        .search-input::placeholder { color: rgba(0, 243, 255, 0.4); }
        .search-icon { color: var(--neon-blue); font-size: 1.2rem; cursor: pointer; position: absolute; right: 20px; }

        /* --- IDLE SCREEN --- */
        .idle-screen {
            position: absolute; inset: 0; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 10;
            background: rgba(0,0,0,0.4); transition: opacity 0.5s;
        }
        .idle-screen.hidden { opacity: 0; pointer-events: none; }
        .rotom-face { font-size: 8rem; color: var(--neon-blue); animation: bounce 3s infinite ease-in-out; filter: drop-shadow(0 0 20px var(--neon-blue)); }
        @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-20px); } }

        /* --- OVERLAYS (LOADING, GLITCH, ERROR) --- */
        .overlay {
            position: absolute; inset: 0;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; transition: opacity 0.2s; opacity: 0; pointer-events: none;
            overflow: hidden;
        }
        .overlay.active { opacity: 1; pointer-events: all; }

        #loading-overlay { background: #050505; }
        .tv-noise {
            position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
            background-image: repeating-radial-gradient(#000 0 0.0001%, #1a1a1a 0 0.0002%);
            background-size: 10px 10px;
            animation: noiseAnim 0.5s infinite linear; opacity: 0.04; pointer-events: none;
        }
        @keyframes noiseAnim { 0% { transform: translate(0, 0); } 100% { transform: translate(10px, 10px); } }
        .antenna-icon { font-size: 5rem; color: var(--neon-orange); margin-bottom: 20px; filter: drop-shadow(0 0 15px var(--neon-orange)); position: relative; z-index: 2; animation: floatAntenna 3s ease-in-out infinite; }
        @keyframes floatAntenna { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-15px); } }
        .glitch-wrapper { position: relative; }
        .glitch-text { font-family: var(--font-mono); font-size: 2.5rem; font-weight: bold; color: white; letter-spacing: 4px; position: relative; z-index: 1; }
        .glitch-text::before, .glitch-text::after { content: attr(data-text); position: absolute; left: 0; top: 0; width: 100%; height: 100%; background: #050505; opacity: 0.8; }
        .glitch-text::before { left: 2px; text-shadow: -1px 0 #ff00c1; clip-path: inset(0 0 0 0); animation: soft-glitch-1 4s infinite linear; }
        .glitch-text::after { left: -2px; text-shadow: -1px 0 #00fff9; clip-path: inset(0 0 0 0); animation: soft-glitch-2 4s infinite linear; }
        @keyframes soft-glitch-1 { 0%,92%{clip-path:inset(0 0 0 0);transform:translate(0)} 93%{clip-path:inset(20% 0 80% 0);transform:translate(-2px,2px)} 94%{clip-path:inset(80% 0 10% 0);transform:translate(2px,-2px)} 95%,100%{clip-path:inset(0 0 0 0);transform:translate(0)} }
        @keyframes soft-glitch-2 { 0%,94%{clip-path:inset(0 0 0 0);transform:translate(0)} 95%{clip-path:inset(10% 0 60% 0);transform:translate(2px,2px)} 96%{clip-path:inset(70% 0 20% 0);transform:translate(-2px,-2px)} 97%,100%{clip-path:inset(0 0 0 0);transform:translate(0)} }

        #response-glitch-overlay { background: #000; animation: screen-glitch 0.4s ease-out both; }
        @keyframes screen-glitch { 0% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%); opacity: 1; } 20% { clip-path: polygon(0 15%, 100% 15%, 100% 20%, 0 20%); } 40% { clip-path: polygon(0 80%, 100% 80%, 100% 82%, 0 82%); } 60% { clip-path: polygon(0 45%, 100% 45%, 100% 55%, 0 55%); } 100% { clip-path: polygon(0 0, 100% 0, 100% 100%, 0 100%); opacity: 0; } }
        
        #error-overlay { background: rgba(5, 5, 5, 0.9); z-index: 300; }
        .error-card { background: rgba(20, 10, 10, 0.8); border: 2px solid var(--rotom-red); border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 0 50px rgba(255, 59, 59, 0.2); width: 600px; max-width: 90%; }
        .error-title { font-size: 2.5rem; text-transform: uppercase; font-weight: 800; color: var(--rotom-red); margin-bottom: 10px; }
        .error-message { font-size: 1.2rem; line-height: 1.6; color: #ddd; margin-bottom: 30px; }
        .error-btn { background: transparent; border: 2px solid var(--rotom-red); color: var(--rotom-red); padding: 12px 40px; cursor: pointer; font-weight: bold; font-family: var(--font-main); text-transform: uppercase; font-size: 1rem; border-radius: 8px; transition: all 0.3s; }
        .error-btn:hover { background: var(--rotom-red); color: black; box-shadow: 0 0 20px rgba(255, 59, 59, 0.5); }
        
        /* --- MAIN STAGE (DESKTOP) --- */
        .main-stage { flex-grow: 1; display: none; padding: 20px 40px; gap: 30px; z-index: 5; opacity: 0; transition: all 0.5s ease; position: relative; height: calc(100% - 70px); box-sizing: border-box; }
        .main-stage.has-drawer { padding-bottom: 200px; }
        .main-stage.active { display: flex; opacity: 1; }

        /* PANEL IZQUIERDO: VISUAL */
        .panel-visual { flex: 1; display: flex; flex-direction: column; background: rgba(255,255,255,0.02); border-radius: 20px; border: 1px solid rgba(255,255,255,0.1); padding: 20px; position: relative; overflow-y: auto; height: 100%; }
        .pk-hologram { min-height: 250px; flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; margin-bottom: 20px; }
        .pk-hologram::after { content: ''; position: absolute; bottom: 30px; width: 60%; height: 40px; background: radial-gradient(ellipse, var(--neon-blue) 0%, transparent 70%); opacity: 0.15; transform: rotateX(60deg); }
        .pk-sprite { max-height: 90%; max-width: 90%; z-index: 2; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); animation: floatPk 5s ease-in-out infinite; transition: filter 0.5s ease; }
        @keyframes floatPk { 0%,100%{transform:translateY(0);} 50%{transform:translateY(-10px);} }

        .sprite-glitching { animation: static-glitch 0.4s ease-out both; }
        @keyframes static-glitch { 0% { clip-path: inset(0 0 0 0); } 10% { clip-path: inset(85% 0 10% 0); } 20% { clip-path: inset(15% 0 70% 0); } 30% { clip-path: inset(75% 0 5% 0); } 40% { clip-path: inset(30% 0 45% 0); } 50% { opacity: 0.5; clip-path: inset(50% 0 50% 0); } 60% { opacity: 1; clip-path: inset(30% 0 45% 0); } 70% { clip-path: inset(75% 0 5% 0); } 80% { clip-path: inset(15% 0 70% 0); } 90% { clip-path: inset(85% 0 10% 0); } 100% { clip-path: inset(0 0 0 0); } }

        .shiny-toggle-btn { position: absolute; top: 15px; right: 15px; z-index: 10; background: rgba(0, 243, 255, 0.1); border: 1px solid var(--neon-blue); color: var(--neon-blue); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; font-size: 1.2rem; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; box-shadow: 0 0 10px rgba(0, 243, 255, 0.2); }
        .shiny-toggle-btn:hover { background: rgba(0, 243, 255, 0.3); transform: scale(1.1); }
        .shiny-toggle-btn.active { background: var(--neon-orange); color: white; border-color: var(--neon-orange); box-shadow: 0 0 15px rgba(255, 157, 0, 0.5); text-shadow: 0 0 10px white; }

        .pk-bio { text-align: center; padding-bottom: 20px; }
        .pk-id { font-family: var(--font-mono); color: #666; font-size: 1.5rem; display: block; }
        .pk-name { font-size: 3.5rem; font-weight: 800; text-transform: uppercase; color: white; line-height: 1; margin-bottom: 10px; text-shadow: 0 0 20px rgba(255,255,255,0.1); transition: filter 0.5s ease; }
        .pk-desc-box { background: rgba(0,0,0,0.5); padding: 15px; border-radius: 10px; border-left: 3px solid var(--neon-orange); color: #ccc; font-size: 1.1rem; line-height: 1.5; text-align: left; margin-top: 15px; }
        .pk-meta-row { font-family: var(--font-mono); color: var(--neon-blue); margin-bottom: 10px; text-transform: capitalize; }

        /* PANEL DERECHO: DATOS */
        .panel-data { flex: 1; display: flex; flex-direction: column; gap: 20px; overflow-y: auto; height: 100%; transition: opacity 0.5s ease; }
        .data-card { background: var(--glass-bg); border: 1px solid rgba(255,255,255,0.1); border-radius: 15px; padding: 20px; overflow: hidden; flex-shrink: 0; }
        .card-header { font-family: var(--font-mono); color: var(--neon-blue); font-size: 1rem; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 15px; padding-bottom: 5px; display: flex; justify-content: space-between; }

        /* STATS */
        .stat-grid { display: grid; gap: 8px; }
        .stat-line { display: grid; grid-template-columns: 40px 1fr 35px; align-items: center; gap: 15px; }
        .stat-label { font-weight: 700; color: #888; font-size: 0.9rem; }
        .stat-bar-bg { height: 10px; background: rgba(255,255,255,0.1); border-radius: 5px; overflow: hidden; }
        .stat-bar-fill { height: 100%; border-radius: 5px; transition: width 1s ease-out; }
        .stat-val { font-family: var(--font-mono); text-align: right; color: white; }

        /* MOVES LIST */
        .moves-grid { display: grid; grid-template-columns: 1fr; gap: 8px; max-height: 350px; overflow-y: auto; padding-right: 5px; }
        .move-row { display: flex; align-items: center; justify-content: space-between; background: rgba(255,255,255,0.05); padding: 12px 15px; border-radius: 8px; cursor: pointer; border: 1px solid transparent; transition: all 0.2s; }
        .move-row:hover { background: rgba(0, 243, 255, 0.1); border-color: var(--neon-blue); transform: translateX(5px); }
        .move-name { font-weight: 700; font-size: 1.1rem; }
        .move-type { font-size: 0.8rem; font-weight: bold; text-transform: uppercase; padding: 3px 8px; border-radius: 4px; color: white; text-shadow: 1px 1px 0 rgba(0,0,0,0.5); }

        /* --- GENERIC STAGE --- */
        .generic-stage { display: none; width: 100%; height: 100%; align-items: center; justify-content: center; padding: 20px; z-index: 5; opacity: 0; transition: opacity 0.5s; }
        .generic-stage.has-drawer { padding-bottom: 200px; }
        .generic-stage.active { display: flex; opacity: 1; }
        .info-card { width: 800px; max-width: 90%; background: rgba(10, 15, 20, 0.95); border: 2px solid var(--neon-orange); border-radius: 20px; padding: 40px; text-align: center; box-shadow: 0 0 50px rgba(255, 94, 0, 0.15); }
        .ic-title { font-size: 3.5rem; text-transform: uppercase; font-weight: 800; color: white; margin-bottom: 10px; }
        .ic-meta { font-family: var(--font-mono); color: var(--neon-blue); font-size: 1.2rem; text-transform: uppercase; margin-bottom: 30px; }
        .ic-body { font-size: 1.3rem; line-height: 1.6; color: #ddd; background: rgba(255,255,255,0.05); padding: 25px; border-radius: 12px; margin-bottom: 30px; }
        .ic-data-row { display: flex; justify-content: center; gap: 40px; }
        .ic-data-point { text-align: center; }
        .ic-lbl { display: block; font-size: 0.8rem; color: #888; margin-bottom: 5px; }
        .ic-val { font-size: 1.8rem; font-weight: bold; color: var(--neon-blue); }

        /* --- DRAWER (RESULTADOS) --- */
        .drawer { position: absolute; bottom: 0; left: 0; width: 100%; height: 180px; background: #080808; border-top: 2px solid var(--neon-blue); transform: translateY(100%); transition: transform 0.4s cubic-bezier(0.2, 0.8, 0.2, 1); z-index: 60; display: grid; grid-template-columns: 50px 1fr 50px; grid-template-rows: 30px 1fr; grid-template-areas: "header header header" "left content right"; }
        .drawer.visible { transform: translateY(0); }
        .drawer-header { grid-area: header; background: var(--neon-blue); color: black; font-weight: bold; text-align: center; font-size: 0.8rem; padding-top: 5px; letter-spacing: 2px; }
        .drawer-content { grid-area: content; display: flex; align-items: center; overflow-x: auto; padding: 10px 0; -webkit-overflow-scrolling: touch; cursor: grab; }
        .drawer-content:active { cursor: grabbing; }
        .drawer-items-wrapper { display: flex; gap: 20px; margin-left: auto; margin-right: auto; padding: 0 20px; }
        .drawer-scroll-btn { grid-row: 2; background: rgba(0, 243, 255, 0.1); border: none; color: var(--neon-blue); font-size: 1.5rem; cursor: pointer; transition: all 0.3s; z-index: 5; display: flex; align-items: center; justify-content: center; }
        .drawer-scroll-btn:hover { background: rgba(0, 243, 255, 0.3); }
        .drawer-scroll-btn.hidden { opacity: 0; pointer-events: none; }
        #scroll-left-btn { grid-column: 1; }
        #scroll-right-btn { grid-column: 3; }
        .mini-card { width: 100px; height: 120px; flex-shrink: 0; background: rgba(255,255,255,0.08); border: 1px solid rgba(255,255,255,0.2); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; position: relative; transition: all 0.2s; }
        .mini-card:hover { transform: translateY(-10px) scale(1.05); background: rgba(255,255,255,0.15); border-color: white; z-index: 10; }
        .mini-card.active { border-color: var(--neon-orange); box-shadow: 0 0 15px rgba(255, 157, 0, 0.4); }
        .mini-rank { position: absolute; top: -10px; left: 50%; transform: translateX(-50%); background: var(--neon-orange); color: white; font-weight: bold; font-size: 0.8rem; padding: 2px 8px; border-radius: 10px; font-family: var(--font-mono); box-shadow: 0 2px 5px rgba(0,0,0,0.5); z-index: 2; }
        .mini-img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 8px; }
        .mini-label { font-size: 0.75rem; text-align: center; width: 90%; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        /* PANEL DE MODERADOR */
        #gm-panel { 
            display: none; 
            position: fixed; 
            top: 90px; right: 30px; 
            background: rgba(10,10,10,0.95); 
            border: 2px solid var(--neon-orange); 
            padding: 15px; z-index: 9000; 
            border-radius: 15px; width: 250px; 
            box-shadow: 0 0 30px rgba(0,0,0,0.5); 
        }
        .gm-control-btn { 
            background: transparent; 
            border: 1px solid var(--neon-blue); 
            color: white; padding: 10px; 
            width: 100%; margin-bottom: 8px; 
            cursor: pointer; font-family: var(--font-main); 
            font-weight: bold; font-size: 0.9rem;
            text-transform: uppercase;
            border-radius: 5px; transition: all 0.3s; 
        }
        .gm-control-btn:hover {
            transform: scale(1.05);
        }

        /* ESTILOS PARA LA INTERFAZ DE CARTAS DINÁMICAS */
        .dynamic-card {
            width: 200px;
            height: 280px;
            background-color: transparent;
            perspective: 1000px;
            flex-shrink: 0;
            cursor: pointer;
            position: relative;
        }

        .card-inner {
            position: relative;
            width: 100%;
            height: 100%;
            text-align: center;
            transition: transform 0.6s;
            transform-style: preserve-3d;
            box-shadow: 0 4px 15px rgba(0,0,0,0.4);
            border-radius: 15px;
        }

        .dynamic-card.is-flipped .card-inner {
            transform: rotateY(180deg);
        }

        .card-front, .card-back {
            position: absolute;
            width: 100%;
            height: 100%;
            -webkit-backface-visibility: hidden;
            backface-visibility: hidden;
            border-radius: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 15px;
        }

        .card-front {
            background: linear-gradient(45deg, #111, #252525);
            color: var(--neon-blue);
            border: 2px solid var(--neon-blue);
        }
        
        .card-front-default-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }
        
        .card-front.has-hints .card-front-default-content {
            filter: blur(5px);
            opacity: 0.4;
        }
        
        .card-front-default-content i {
            font-size: 4rem;
            filter: drop-shadow(0 0 10px var(--neon-blue));
        }
        .card-front-text {
            font-family: var(--font-mono);
            margin-top: 15px;
            letter-spacing: 2px;
        }

        .card-back {
            background-color: var(--glass-bg);
            color: white;
            transform: rotateY(180deg);
            border: 2px solid var(--neon-orange);
        }
        .card-img {
            max-width: 90%;
            max-height: 120px;
            object-fit: contain;
            margin-bottom: 10px;
            filter: drop-shadow(0 5px 10px rgba(0,0,0,0.5));
        }
        .card-title {
            font-weight: bold;
            font-size: 1.2rem;
            text-transform: uppercase;
            line-height: 1.2;
        }
        .card-meta {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            text-transform: uppercase;
            color: #ccc;
            margin-top: 5px;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .card-front.gm-preview-active {
            background: var(--glass-bg);
            border-color: rgba(0, 243, 255, 0.4);
            border-style: dashed;
        }
        .gm-preview-content {
            opacity: 0.5;
            filter: grayscale(1);
            transition: all 0.3s;
        }
        .dynamic-card:hover .gm-preview-content {
            opacity: 1;
            filter: grayscale(0);
        }

        .gm-hint-menu {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            border-radius: 8px;
            border: 1px solid var(--neon-orange);
            padding: 8px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 10;
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
            transition: all 0.2s ease-in-out;
        }

        .dynamic-card:not(.is-flipped):hover .gm-hint-menu {
            opacity: 1;
            transform: scale(1);
            pointer-events: auto;
        }

        .gm-hint-btn {
            background: transparent;
            border: 1px solid var(--neon-blue);
            color: var(--neon-blue);
            border-radius: 4px;
            padding: 5px;
            cursor: pointer;
            font-size: 0.7rem;
            font-family: var(--font-mono);
            transition: all 0.2s;
        }
        .gm-hint-btn:hover {
            background: var(--neon-blue);
            color: black;
        }

        .hints-container {
            position: absolute;
            bottom: 15px;
            left: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .card-hint-text {
            background: rgba(0,0,0,0.8);
            padding: 10px;
            border-radius: 5px;
            font-size: 0.9rem;
            color: #fff;
            border-left: 3px solid var(--neon-orange);
            text-align: center;
            font-family: var(--font-mono);
            text-shadow: 0 0 8px var(--neon-orange);
            animation: fadeInUp 0.5s 0.2s ease-out both;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card-hint-text i {
            margin-bottom: 6px;
            color: var(--neon-orange);
            font-size: 1.4rem;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .silhouette-img {
            max-width: 90%;
            max-height: 180px;
            object-fit: contain;
            filter: brightness(0) contrast(200%) drop-shadow(0 0 8px var(--neon-blue));
            animation: fadeInUp 0.5s ease-out both;
        }

        /* --- MEDIA QUERIES (ADAPTACIÓN MÓVIL) --- */
        @media (max-width: 768px) {
            .rotom-chassis { width: 100%; height: 100%; border-radius: 0; padding: 0; box-shadow: none; }
            .screen-bezel { border-radius: 0; padding: 0; box-shadow: none; }
            .screen-display { border-radius: 0; border: none; }
            .rotom-camera { top: 5px; width: 8px; height: 8px; }
            .ui-header { height: 60px; padding: 0 10px; }
            .search-bar-container { width: 90%; min-width: auto; padding: 5px 15px; }
            .search-input { font-size: 1rem; }
            
            .main-stage { flex-direction: column; padding: 10px 10px 80px 10px; overflow-y: auto; display: block; }
            .main-stage.has-drawer { padding-bottom: 260px !important; }
            
            .panel-visual { flex: none; width: 100%; height: auto; min-height: auto; margin-bottom: 15px; padding: 15px; overflow: visible; }
            .pk-hologram { min-height: 180px; }
            .pk-name { font-size: 2.5rem; }
            .panel-data { flex: none; width: 100%; height: auto; overflow: visible; }
            .stat-line { gap: 10px; font-size: 0.8rem; }
            .moves-grid { max-height: none; }
            
            .generic-stage { display: none; position: absolute !important; top: 70px !important; left: 0 !important; width: 100% !important; height: calc(100% - 70px) !important; background: #050505; z-index: 50 !important; overflow-y: auto !important; padding: 0 !important; flex-direction: column !important; justify-content: flex-start !important; align-items: center !important; }
            .generic-stage.active { display: block !important; }
            .info-card { display: block !important; width: 90% !important; max-width: none !important; margin: 20px auto 150px auto !important; height: auto !important; position: relative !important; transform: none !important; }
            .ic-title { font-size: 2rem; }
            .ic-data-row { flex-direction: column; gap: 15px; }
            .drawer { display: flex; flex-direction: column; }
            .drawer-scroll-btn { display: none; }
            .drawer-content { justify-content: flex-start; }
            .drawer-items-wrapper { margin: 0; }
            .rotom-face { font-size: 5rem; }
            .antenna-icon { font-size: 4rem; }
            .glitch-text { font-size: 1.5rem; }

            #gm-panel { top: 70px; right: 10px; width: 200px; padding: 10px; }
            .gm-control-btn { font-size: 0.8rem; }

            .dynamic-card { width: 150px; height: 210px; }
            .card-title { font-size: 1rem; }
        }
    </style>
</head>
<body>

    <!-- MODAL DE SELECCIÓN DE MODO -->
    <div id="mode-selection-overlay" class="overlay active" style="background: rgba(0,0,0,0.95); z-index: 200;">
        <div class="info-card" style="border-color: var(--neon-blue); width: 600px;">
            <h2 class="ic-title">RotomDex OS</h2>
            <p class="ic-meta">SELECCIONA EL MODO DE OPERACIÓN</p>
            
            <button onclick="iniciarModo('normal')" class="error-btn" style="border-color: #ccc; color: #ccc; width: 80%; padding: 15px; font-size: 1.2rem;">MODO NORMAL</button>

            <div style="height:1px; background:rgba(255,255,255,0.1); margin: 30px auto; width: 80%;"></div>
            
            <p style="color: #888; margin-bottom: 15px;">Para unirte o crear una dinámica, introduce un código de sala:</p>
            <input type="text" id="sala-input" class="search-input" placeholder="CÓDIGO DE SALA..." style="width: 280px; margin: auto;">
            
            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 20px;">
                <button onclick="iniciarModo('gm')" class="error-btn" style="border-color:var(--neon-orange); color:var(--neon-orange);">MODERADOR</button>
                <button onclick="iniciarModo('espectador')" class="error-btn" style="border-color:var(--neon-blue); color:var(--neon-blue);">ESPECTADOR</button>
            </div>
        </div>
    </div>

    <!-- EL POPUP DE ERROR -->
    <div id="error-overlay" class="overlay">
        <div class="error-card">
            <h2 id="error-title" class="error-title">ERROR</h2>
            <p id="error-message" class="error-message">Mensaje de error.</p>
            <button id="error-btn-close" class="error-btn">ENTENDIDO</button>
        </div>
    </div>

    <!-- MODAL PARA PISTAS -->
    <div id="prompt-overlay" class="overlay" style="z-index: 400;">
        <div class="info-card" style="border-color: var(--neon-blue); width: 600px;">
            <h2 id="prompt-title" class="ic-title" style="font-size: 2.5rem;">Añadir Pista</h2>
            <input type="text" id="prompt-input" class="search-input" style="width: 80%; margin: 20px auto;">
            <div style="display: flex; gap: 20px; justify-content: center; margin-top: 30px;">
                <button id="prompt-confirm-btn" class="error-btn" style="border-color:var(--neon-blue); color:var(--neon-blue);">CONFIRMAR</button>
                <button id="prompt-cancel-btn" class="error-btn" style="border-color:#ccc; color:#ccc;">CANCELAR</button>
            </div>
        </div>
    </div>

    <!-- PANEL DE CONTROL DEL GM -->
    <div id="gm-panel">
        <div id="gm-sala-id" style="color:var(--neon-orange); font-size:0.9rem; text-align:center; margin-bottom:12px; font-weight:bold; letter-spacing:1px; font-family:var(--font-mono);">SALA: ---</div>
        <button onclick="controlRevelarTodo(true)" class="gm-control-btn" style="border-color: var(--neon-blue); color: var(--neon-blue);">REVELAR TODO</button>
        <button onclick="controlRevelarTodo(false)" class="gm-control-btn" style="border-color: var(--neon-orange); color: var(--neon-orange);">OCULTAR TODO</button>
        <button onclick="cerrarSesionGM()" class="gm-control-btn" style="border-color:var(--rotom-red); color:var(--rotom-red); margin-top:10px; font-size:0.8rem;">CERRAR SESIÓN</button>
    </div>

    <div class="rotom-chassis">
        <div class="screen-bezel">
            <div class="rotom-camera"></div>
            
            <div class="screen-display">
                
                <!-- Header -->
                <div class="ui-header">
                    <div id="search-bar-container" class="search-bar-container">
                        <input type="text" id="search-input" class="search-input" placeholder="BUSCAR POKÉMON...">
                        <i class="fas fa-search search-icon" id="btn-search"></i>
                    </div>
                </div>

                <!-- Overlays -->
                <div id="response-glitch-overlay" class="overlay"></div>
                <div id="loading-overlay" class="overlay">
                    <div class="tv-noise"></div>
                    <i class="fas fa-satellite-dish antenna-icon"></i>
                    <div class="glitch-wrapper">
                        <div class="glitch-text" data-text="BUSCANDO DATOS...">BUSCANDO DATOS...</div>
                    </div>
                </div>

                <!-- Idle (Solo para modo normal) -->
                <div id="idle-screen" class="idle-screen">
                    <i class="fas fa-bolt rotom-face"></i>
                    <p style="color:#aaa; margin-top:30px; letter-spacing:3px; font-family:var(--font-mono);">SISTEMA EN ESPERA</p>
                </div>

                <!-- Main Stage (Modo Normal) -->
                <div id="pokemon-stage" class="main-stage">
                    <div class="panel-visual">
                        <div class="pk-hologram">
                            <img id="main-sprite" src="" class="pk-sprite">
                            <button id="shiny-toggle" class="shiny-toggle-btn"><i class="fas fa-star"></i></button>
                        </div>
                        <div class="pk-bio">
                            <span id="main-id" class="pk-id">#000</span>
                            <div id="main-name" class="pk-name">---</div>
                            <div id="type-container" class="pk-meta-row" style="display:flex; gap:10px; justify-content:center; margin-bottom:15px;"></div>
                            <div class="pk-meta-row">
                                <span id="main-h" style="margin-right:20px;">ALT: --m</span>
                                <span id="main-w">PESO: --kg</span>
                            </div>
                            <div id="main-gender-ratio" class="pk-meta-row"></div>
                            <div id="main-egg-groups" class="pk-meta-row"></div>
                            <div id="main-desc" class="pk-desc-box">---</div>
                        </div>
                    </div>
                    <div class="panel-data">
                        <div class="data-card">
                            <div class="card-header"><span>ESTADÍSTICAS</span> <i class="fas fa-chart-bar"></i></div>
                            <div id="stats-container" class="stat-grid"></div>
                        </div>
                        <div class="data-card" style="margin-top:15px; display:flex; flex-direction:column;">
                            <div class="card-header"><span>MOVIMIENTOS</span> <i class="fas fa-list-ul"></i></div>
                            <div id="moves-container" class="moves-grid"></div>
                        </div>
                    </div>
                </div>

                <!-- Generic Stage (Modo Normal) -->
                <div id="generic-stage" class="generic-stage">
                    <div class="info-card" id="generic-content"></div>
                </div>

                <!-- Contenedor de la etapa dinámica -->
                <div id="dynamic-stage" class="main-stage" style="display: none; flex-direction: column; padding: 20px; overflow-y: auto;">
                    <h2 id="dynamic-stage-title" class="ic-title" style="font-size: 2rem; margin-bottom: 20px; display: none; text-shadow: 0 0 10px var(--neon-blue);"></h2>
                    <div id="card-grid" style="display: flex; flex-wrap: wrap; gap: 20px; justify-content: center; width: 100%;">
                        <!-- Las cartas se generarán aquí con JavaScript -->
                    </div>
                </div>

                <!-- Drawer (Modo Normal) -->
                <div id="results-drawer" class="drawer">
                    <div class="drawer-header" id="drawer-count">RESULTADOS ADICIONALES</div>
                    <button id="scroll-left-btn" class="drawer-scroll-btn hidden"><i class="fas fa-chevron-left"></i></button>
                    <div class="drawer-content" id="drawer-grid">
                        <div class="drawer-items-wrapper" id="drawer-items-wrapper"></div>
                    </div>
                    <button id="scroll-right-btn" class="drawer-scroll-btn hidden"><i class="fas fa-chevron-right"></i></button>
                </div>

            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN FIREBASE (Usa tus propias credenciales)
        const firebaseConfig = {
            apiKey: "AIzaSyCDhVatfFwJT851d14jmoMzxY7scpctf84",
            authDomain: "pokedexos.firebaseapp.com",
            databaseURL: "https://pokedexos-default-rtdb.firebaseio.com",
            projectId: "pokedexos",
            storageBucket: "pokedexos.firebasestorage.app",
            messagingSenderId: "130941745308",
            appId: "1:130941745308:web:3e48df051a8b1036c1d559",
            measurementId: "G-HTXMQVPH5N"
        };
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwivIdb0VeUE0RyyclqJWC7BX3BmZkvvd0z05zJvKSZj-VLuvFN6r9d4-i_trij2EvA/exec';
        
        let db = { pokemon: null, habilidades: null, movimientos: null, items: null };
        let currentResults = [];
        let currentPokemon = null;
        let showingShiny = false;
        let isAnimatingShiny = false;

        let modoActual = 'normal';
        let salaID = '';
        let isGM = false;
        let lastRenderKey = null;
        let currentErrorCallback = null;

        const typeColors = {
            normal: '#A8A77A', fire: '#EE8130', water: '#6390F0', electric: '#F7D02C',
            grass: '#7AC74C', ice: '#96D9D6', fighting: '#C22E28', poison: '#A33EA1',
            ground: '#E2BF65', flying: '#A98FF3', psychic: '#F95587', bug: '#A6B91A',
            rock: '#B6A136', ghost: '#735797', dragon: '#6F35FC', dark: '#705746',
            steel: '#B7B7CE', fairy: '#D685AD'
        };
        const statColors = { ps:'#FF5959', ataque:'#F5AC78', defensa:'#FAE078', ataque_especial:'#9DB7F5', defensa_especial:'#A7DB8D', velocidad:'#FA92B2' };

        document.addEventListener('DOMContentLoaded', () => {
            loadDB();
            const inp = document.getElementById('search-input');
            const btn = document.getElementById('btn-search');
            inp.addEventListener('keyup', e => { if(e.key==='Enter') runSearch(); });
            btn.addEventListener('click', runSearch);

            document.getElementById('shiny-toggle').addEventListener('click', toggleShiny);
            
            document.getElementById('error-btn-close').addEventListener('click', () => {
                if(typeof currentErrorCallback === 'function') {
                    currentErrorCallback();
                }
            });

            setupDrawerScrolling();
        });

        function setupDrawerScrolling() {
            const slider = document.getElementById('drawer-grid');
            const leftBtn = document.getElementById('scroll-left-btn');
            const rightBtn = document.getElementById('scroll-right-btn');
            let isDown = false, startX, scrollLeft;

            slider.addEventListener('mousedown', (e) => { isDown = true; startX = e.pageX - slider.offsetLeft; scrollLeft = slider.scrollLeft; });
            slider.addEventListener('mouseleave', () => { isDown = false; });
            slider.addEventListener('mouseup', () => { isDown = false; });
            slider.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - slider.offsetLeft;
                const walk = (x - startX) * 2;
                slider.scrollLeft = scrollLeft - walk;
            });
            leftBtn.addEventListener('click', () => { slider.scrollBy({ left: -300, behavior: 'smooth' }); });
            rightBtn.addEventListener('click', () => { slider.scrollBy({ left: 300, behavior: 'smooth' }); });
        }

        async function loadDB() {
            try { 
                await Promise.all(['pokemon', 'habilidades', 'movimientos', 'items'].map(async f => {
                    const r = await fetch(`${f}.json`); 
                    db[f] = await r.json();
                })); 
            } catch(e){ console.error("Error cargando las bases de datos:", e); }
        }
        
        function iniciarModo(modo) {
            modoActual = modo;
            
            if (modo === 'normal') {
                document.getElementById('mode-selection-overlay').classList.remove('active');
                return;
            }

            salaID = document.getElementById('sala-input').value.trim().toUpperCase();
            if (!salaID) {
                showError(
                    'CÓDIGO REQUERIDO', 
                    'Debes introducir un código de sala para iniciar en modo Moderador o Espectador.',
                    () => { document.getElementById('error-overlay').classList.remove('active'); }
                );
                return;
            }
            
            document.getElementById('pokemon-stage').style.display = 'none';
            document.getElementById('generic-stage').style.display = 'none';
            document.getElementById('results-drawer').style.display = 'none';
            document.getElementById('idle-screen').style.display = 'none';
            const dynamicStage = document.getElementById('dynamic-stage');
            dynamicStage.style.display = 'flex';
            dynamicStage.classList.add('active');


            if (modo === 'gm') {
                isGM = true;
                document.getElementById('gm-panel').style.display = 'block';
                document.getElementById('gm-sala-id').textContent = `SALA: ${salaID}`;
                conectarASala();
            } else { // modo 'espectador'
                isGM = false;
                document.getElementById('search-bar-container').style.display = 'none';
                conectarASala();
            }

            document.getElementById('mode-selection-overlay').classList.remove('active');
        }

        async function runSearch() {
            const val = document.getElementById('search-input').value.trim();
            if(!val) return;
            if(!db.pokemon || !db.items) await loadDB();

            document.getElementById('loading-overlay').classList.add('active');
            if (modoActual === 'normal') {
                document.getElementById('idle-screen').classList.add('hidden');
                document.getElementById('results-drawer').classList.remove('visible');
                document.getElementById('pokemon-stage').classList.remove('has-drawer', 'active');
                document.getElementById('generic-stage').classList.remove('has-drawer', 'active');
            }

            const s = document.createElement('script');
            const cb = 'rotom_'+Date.now();
            window[cb] = (r) => { handleRes(r, val); delete window[cb]; document.body.removeChild(s); };
            s.src = `${APPS_SCRIPT_URL}?query=${encodeURIComponent(val)}&callback=${cb}`;
            s.onerror = () => {
                document.getElementById('loading-overlay').classList.remove('active');
                showError('ERROR DE CONEXIÓN', 'No se pudo contactar con los servidores de RotomDex.');
            };
            document.body.appendChild(s);
        }

        function handleRes(raw, query) {
            const loadingOverlay = document.getElementById('loading-overlay');
            const glitchOverlay = document.getElementById('response-glitch-overlay');
            loadingOverlay.classList.remove('active');
            glitchOverlay.classList.add('active');

            setTimeout(() => {
                glitchOverlay.classList.remove('active');
                
                let data = null;
                try {
                    let str = "";
                    if (typeof raw === 'object' && raw.choices) str = raw.choices[0].message.content;
                    else if (typeof raw === 'string') { try { str = JSON.parse(raw).choices[0].message.content } catch { str = raw } }
                    else str = JSON.stringify(raw);
                    const match = str.match(/\{[\s\S]*"target"[\s\S]*\}/) || str.match(/\{[\s\S]*\}/);
                    if (match) data = JSON.parse(match[0]); else throw new Error();
                } catch (e) { showError('ERROR DE INTERPRETACIÓN', 'Respuesta de IA no válida.'); return; }

                if (data.error) { showError('ERROR DE IA', data.error); return; }

                const res = applyFilters(data);
                if (res.length === 0) { showError('BÚSQUEDA SIN ÉXITO', 'No se encontraron resultados.'); return; }
                
                currentResults = res;
                
                if (modoActual === 'normal') {
                    actualizarUI(res, data.target);
                    return;
                }
                
                if (isGM && salaID) {
                    const newSearchData = { 
                        target: data.target, 
                        results: res,
                        search_id: Date.now(),
                        query: query
                    };
                    database.ref(`salas/${salaID}/current_search`).set(newSearchData);
                    database.ref(`salas/${salaID}/controls/revealed_cards`).set(null);
                    database.ref(`salas/${salaID}/controls/card_hints`).set(null);
                }

            }, 400);
        }

        function actualizarUI(res, target) {
            if (res.length > 1) updateDrawer(res, target);
            else document.getElementById('results-drawer').classList.remove('visible');

            if (target === 'pokemon') showPokemonMode(res);
            else showGenericView(res[0], target);
        }
        
        function showPokemonMode(res) {
            document.getElementById('generic-stage').classList.remove('active');
            const stg = document.getElementById('pokemon-stage');
            stg.classList.add('active');
            if(res.length > 1) stg.classList.add('has-drawer');
            else stg.classList.remove('has-drawer');
            renderMain(res[0]);
        }

        function showGenericView(item, type) {
            document.getElementById('pokemon-stage').classList.remove('active');
            const stg = document.getElementById('generic-stage');
            stg.classList.add('active');
            if(currentResults.length > 1) stg.classList.add('has-drawer');
            else stg.classList.remove('has-drawer');
            renderGeneric(item, type);
        }

        function renderMain(p) {
            if (!p) return;
            currentPokemon = p;
            showingShiny = false;
            
            document.getElementById('main-sprite').src = currentPokemon.sprites.artwork_oficial;
            document.getElementById('shiny-toggle').classList.remove('active');
            document.getElementById('main-id').textContent = `#${String(p.id).padStart(3,'0')}`;
            document.getElementById('main-name').textContent = p.nombre;
            document.getElementById('main-desc').textContent = p.descripcion_pokedex || "Sin datos.";
            document.getElementById('main-h').textContent = `ALT: ${p.altura_m}m`;
            document.getElementById('main-w').textContent = `PESO: ${p.peso_kg}kg`;
            
            document.getElementById('main-gender-ratio').textContent = `Género: ${formatGenderRatio(p.ratio_genero)}`;
            document.getElementById('main-egg-groups').textContent = `Grupos Huevo: ${p.grupos_huevo.join(', ')}`;

            document.getElementById('type-container').innerHTML = p.tipos.map(t=> `<span style="background:${typeColors[t]||'#555'}; padding:5px 15px; border-radius:4px; font-weight:bold; color:white; text-transform:uppercase; text-shadow:1px 1px 0 rgba(0,0,0,0.5);">${t}</span>`).join('');

            const labs = {ps:'PS',ataque:'ATK',defensa:'DEF',ataque_especial:'SPA',defensa_especial:'SPD',velocidad:'SPE'};
            document.getElementById('stats-container').innerHTML = Object.entries(p.stats_base).map(([k,v])=>`
                <div class="stat-line">
                    <div class="stat-label">${labs[k]}</div>
                    <div class="stat-bar-bg"><div class="stat-bar-fill" style="width:${Math.min((v/200)*100,100)}%; background:${statColors[k]};"></div></div>
                    <div class="stat-val">${v}</div>
                </div>
            `).join('');

            if(p.movimientos_ids && db.movimientos) {
                const moves = p.movimientos_ids.map(id=>db.movimientos.find(m=>m.id===id)).filter(Boolean).slice(0,50);
                document.getElementById('moves-container').innerHTML = moves.map(m=>`
                    <div class="move-row" onclick="openMoveDetails(${m.id})">
                        <span class="move-name">${m.nombre}</span>
                        <span class="move-type" style="background:${typeColors[m.tipo]}">${m.tipo}</span>
                    </div>
                `).join('');
            } else { document.getElementById('moves-container').innerHTML = '<div style="padding:10px;">Sin datos.</div>'; }
        }

        function formatGenderRatio(ratio) {
            switch(ratio) {
                case -1: return 'Sin Género';
                case 0: return '100% Macho';
                case 1: return '87.5% Macho, 12.5% Hembra';
                case 2: return '75% Macho, 25% Hembra';
                case 4: return '50% Macho, 50% Hembra';
                case 6: return '25% Macho, 75% Hembra';
                case 8: return '100% Hembra';
                default: return 'Desconocido';
            }
        }
        
        function toggleShiny() {
            if (!currentPokemon || isAnimatingShiny) return;
            isAnimatingShiny = true;
            showingShiny = !showingShiny;
            const img = document.getElementById('main-sprite');
            
            img.classList.add('sprite-glitching');
            const onAnimationEnd = () => {
                img.classList.remove('sprite-glitching');
                isAnimatingShiny = false;
                img.removeEventListener('animationend', onAnimationEnd);
            };
            img.addEventListener('animationend', onAnimationEnd);
            setTimeout(() => { img.src = showingShiny ? currentPokemon.sprites.artwork_oficial_shiny : currentPokemon.sprites.artwork_oficial; }, 150);
            document.getElementById('shiny-toggle').classList.toggle('active', showingShiny);
        }

        window.openMoveDetails = function(id) {
            const m = db.movimientos.find(x=>x.id===id);
            if(m) showGenericView(m, 'movimientos');
            document.getElementById('results-drawer').classList.remove('visible');
            document.getElementById('pokemon-stage').classList.remove('has-drawer');
        }

        function renderGeneric(item, type) {
            const card = document.getElementById('generic-content');
            let html = '';
            if(type==='movimientos') { html = `<div class="ic-title">${item.nombre}</div><div class="ic-meta" style="color:${typeColors[item.tipo]}">${item.tipo} - MOVIMIENTO</div><div class="ic-body">${item.descripcion||"Sin descripción."}</div><div class="ic-data-row"><div class="ic-data-point"><span class="ic-lbl">POTENCIA</span><span class="ic-val">${item.potencia||'-'}</span></div><div class="ic-data-point"><span class="ic-lbl">PRECISIÓN</span><span class="ic-val">${item.precision||'-'}</span></div><div class="ic-data-point"><span class="ic-lbl">PP</span><span class="ic-val">${item.pp||'-'}</span></div></div>`; } 
            else if (type === 'items') { html = `<div class="ic-title">${item.nombre}</div><div class="ic-meta">${item.categoria} - OBJETO</div><div class="ic-body">${item.descripcion||"Sin descripción."}</div><div class="ic-data-row"><div class="ic-data-point"><span class="ic-lbl">COSTO</span><span class="ic-val">${item.costo > 0 ? item.costo : 'No se puede comprar'}</span></div></div>`; } 
            else { html = `<div class="ic-title">${item.nombre}</div><div class="ic-meta">HABILIDAD</div><div class="ic-body">${item.descripcion}</div><div class="ic-data-point"><span class="ic-lbl">POKÉMON COMPATIBLES</span><span class="ic-val">${item.pokemon_con_habilidad_count}</span></div>`; }
            html += `<button onclick="closeGeneric()" style="margin-top:30px; background:transparent; border:1px solid #666; color:#aaa; padding:10px 30px; cursor:pointer; font-weight:bold;">VOLVER</button>`;
            card.innerHTML = html;
        }

        window.closeGeneric = function() {
            if(currentResults.length>0 && currentResults[0].stats_base) {
                showPokemonMode(currentResults);
                if(currentResults.length > 1) document.getElementById('results-drawer').classList.add('visible');
            } else { 
                document.getElementById('generic-stage').classList.remove('active'); 
                document.getElementById('idle-screen').classList.remove('hidden'); 
            }
        }
        
        function updateDrawer(res, type) {
            const d = document.getElementById('results-drawer');
            const g = document.getElementById('drawer-items-wrapper'); 
            const c = document.getElementById('drawer-count');
            
            d.classList.add('visible');
            c.textContent = `${res.length} RESULTADOS ENCONTRADOS`;
            
            const cardsHtml = res.map((item,i)=>`<div class="mini-card ${i===0?'active':''}" onclick="selectItem(${i}, '${type}')"><div class="mini-rank">#${i+1}</div><img src="${ type === 'pokemon' ? item.sprites.artwork_oficial : type === 'items' ? item.sprite_url : 'https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/items/poke-ball.png'}" class="mini-img"><div class="mini-label">${item.nombre}</div></div>`).join('');
            g.innerHTML = cardsHtml;
            updateDrawerControls();
        }

        function updateDrawerControls() {
            const slider = document.getElementById('drawer-grid');
            const leftBtn = document.getElementById('scroll-left-btn');
            const rightBtn = document.getElementById('scroll-right-btn');
            setTimeout(() => {
                const isScrollable = slider.scrollWidth > slider.clientWidth;
                leftBtn.classList.toggle('hidden', !isScrollable);
                rightBtn.classList.toggle('hidden', !isScrollable);
            }, 100);
        }

        window.selectItem = function(i, type) {
            document.querySelectorAll('.mini-card').forEach(c=>c.classList.remove('active'));
            document.querySelectorAll('.mini-card')[i].classList.add('active');
            if(type==='pokemon') { renderMain(currentResults[i]); document.getElementById('pokemon-stage').classList.add('active'); document.getElementById('generic-stage').classList.remove('active'); }
            else showGenericView(currentResults[i], type);
        }

        function applyFilters(ins) {
            if (!db[ins.target]) return [];
            let r = [...db[ins.target]];
            if (ins.filters) {
                const filters = JSON.parse(JSON.stringify(ins.filters));
                for (const filter of filters) {
                    if (filter.field === 'habilidad_nombre') { const h = db.habilidades.find(h => h.nombre === filter.value); if(h){ filter.field = 'habilidades_ids'; filter.value = h.id; }}
                    if (filter.field === 'movimiento_nombre') { const m = db.movimientos.find(m => m.nombre === filter.value); if(m){ filter.field = 'movimientos_ids'; filter.value = m.id; }}
                    if (filter.field === 'pokemon_nombre') { const p = db.pokemon.find(p => p.nombre === filter.value); if(p){ filter.field = 'id'; filter.value = p.movimientos_ids; filter.operator = 'is_in'; }}
                }
                r = r.filter(i => { return filters.every(f => {
                    const val = f.field.split('.').reduce((o,x)=>o?.[x],i);
                    if (val === undefined) return false;
                    let d=val,v=f.value; if(typeof d==='string')d=d.toLowerCase(); if(typeof v==='string')v=v.toLowerCase();
                    switch (f.operator) {
                        case 'includes': if (Array.isArray(d)) return d.includes(v); return String(d).includes(v);
                        case 'not_includes': return Array.isArray(d)?!d.some(x=>String(x).toLowerCase().includes(v)):!String(d).includes(v);
                        case 'equals':case'=': return Array.isArray(d)?d.includes(v):d==v;
                        case 'greater_than':case'gt': return Number(d)>Number(v);
                        case 'less_than':case'lt': return Number(d)<Number(v);
                        case 'is_in': return Array.isArray(v) && v.includes(d);
                        case 'starts_with': return String(d).startsWith(v);
                        default: return true;
                    }
                }); });
            }
            if (ins.sortBy) { r.sort((a,b)=>{const va=ins.sortBy.field.split('.').reduce((o,x)=>o?.[x],a)||0,vb=ins.sortBy.field.split('.').reduce((o,x)=>o?.[x],b)||0;return ins.sortBy.direction==='desc'?(Number(vb)-Number(va)):(Number(va)-Number(vb));}); } 
            else if (ins.limit && r.length > 1) { r.sort(() => Math.random() - 0.5); }
            return ins.limit ? r.slice(0, ins.limit) : r;
        }

        function showError(title, message, onCloseCallback = null) {
            document.getElementById('error-title').textContent = title;
            document.getElementById('error-message').textContent = message;
            document.getElementById('error-overlay').classList.add('active');
            currentErrorCallback = onCloseCallback || hideError;
        }

        function hideError() {
            document.getElementById('error-overlay').classList.remove('active');
            if (modoActual === 'normal') {
                document.getElementById('idle-screen').classList.remove('hidden');
            }
        }

        // ---- NUEVAS FUNCIONES PARA EL MODO DINÁMICA ----

        function conectarASala() {
            const salaRef = database.ref('salas/' + salaID);
            salaRef.on('value', (snapshot) => {
                const data = snapshot.val();
                const cardGrid = document.getElementById('card-grid');
                const titleEl = document.getElementById('dynamic-stage-title');
                
                if (!data || !data.current_search) {
                    cardGrid.innerHTML = `<p style="font-family: var(--font-mono); font-size: 1.5rem; color: #666;">Esperando datos del moderador en la sala ${salaID}...</p>`;
                    titleEl.style.display = 'none';
                    lastRenderKey = null;
                    return;
                }

                if (data.current_search.query) {
                    titleEl.textContent = `Resultados para: "${data.current_search.query}"`;
                    titleEl.style.display = 'block';
                } else {
                    titleEl.style.display = 'none';
                }

                currentResults = data.current_search.results;
                const controls = data.controls || {};
                renderCardGrid(data.current_search, controls);
            });
        }

        function renderCardGrid(searchData, controls) {
            const dynamicStage = document.getElementById('dynamic-stage');
            const cardGrid = document.getElementById('card-grid');
            const revealedCards = controls.revealed_cards || {};
            const cardHints = controls.card_hints || {};
            const currentRenderKey = searchData.search_id;

            if (currentRenderKey !== lastRenderKey) {
                cardGrid.innerHTML = '';
                searchData.results.forEach((item, index) => {
                    let backContentHTML = '';
                    if (searchData.target === 'pokemon') {
                        const typesHTML = item.tipos.map(t => `<span style="background:${typeColors[t]||'#555'}; padding:2px 6px; border-radius:3px; font-size:0.7rem;">${t}</span>`).join(' ');
                        backContentHTML = `<img src="${item.sprites.artwork_oficial}" class="card-img"><div class="card-title">${item.nombre}</div><div class="card-meta">${typesHTML}</div>`;
                    } else {
                        const iconClass = searchData.target === 'movimientos' ? 'fa-fist-raised' : 'fa-star';
                        const color = searchData.target === 'movimientos' ? typeColors[item.tipo] : 'var(--neon-orange)';
                        backContentHTML = `<i class="fas ${iconClass}" style="font-size:3rem; color:${color}; margin-bottom:15px;"></i><div class="card-title">${item.nombre}</div><div class="card-meta">${item.categoria || item.tipo}</div>`;
                    }

                    const gmClickEvent = isGM ? `onclick="revelarCarta(${index})"` : 'style="cursor: default;"';
                    const gmHintMenu = isGM ? `
                        <div class="gm-hint-menu">
                            <button class="gm-hint-btn" onclick="event.stopPropagation(); addTextHint(${index}, 1);">Pista 1</button>
                            <button class="gm-hint-btn" onclick="event.stopPropagation(); addTextHint(${index}, 2);">Pista 2</button>
                            <button class="gm-hint-btn" onclick="event.stopPropagation(); revealSilhouette(${index});">Silueta</button>
                        </div>
                    ` : '';
                    
                    const defaultFrontContent = `<div class="card-front-default-content"><i class="fas fa-question"></i><div class="card-front-text">OCULTO</div></div>`;

                    cardGrid.innerHTML += `
                        <div id="dynamic-card-${index}" class="dynamic-card" ${gmClickEvent}>
                            ${gmHintMenu}
                            <div class="card-inner">
                                <div class="card-front" id="card-front-${index}">${defaultFrontContent}</div>
                                <div class="card-back">${backContentHTML}</div>
                            </div>
                        </div>
                    `;
                });
                lastRenderKey = currentRenderKey;
            }

            searchData.results.forEach((item, index) => {
                const card = document.getElementById(`dynamic-card-${index}`);
                const cardFront = document.getElementById(`card-front-${index}`);
                if (!card || !cardFront) return;

                const hints = cardHints[index] || {};
                const isRevealed = revealedCards[index] === true;
                
                card.classList.toggle('is-flipped', isRevealed);

                if (isGM) {
                    const typesHTML = item.tipos ? item.tipos.map(t => `<span style="background:${typeColors[t]||'#555'}; padding:2px 6px; border-radius:3px; font-size:0.7rem;">${t}</span>`).join(' ') : (item.tipo || item.categoria);
                    const gmBackContent = `<img src="${item.sprites?.artwork_oficial || ''}" class="card-img"><div class="card-title">${item.nombre}</div><div class="card-meta">${typesHTML}</div>`;
                    cardFront.innerHTML = `<div class="gm-preview-content">${gmBackContent}</div>`;
                    cardFront.classList.add('gm-preview-active');
                } else {
                    cardFront.classList.remove('gm-preview-active');
                    
                    if (hints.show_silhouette && searchData.target === 'pokemon') {
                        cardFront.innerHTML = `<img src="${item.sprites.artwork_oficial}" class="silhouette-img">`;
                        cardFront.classList.remove('has-hints');
                    } else {
                        let defaultContent = cardFront.querySelector('.card-front-default-content');
                        if (!defaultContent) {
                            defaultContent = document.createElement('div');
                            defaultContent.className = 'card-front-default-content';
                            defaultContent.innerHTML = `<i class="fas fa-question"></i><div class="card-front-text">OCULTO</div>`;
                            cardFront.innerHTML = ''; // Limpiamos por si había una silueta antes
                            cardFront.appendChild(defaultContent);
                        }

                        let hintsContainer = cardFront.querySelector('.hints-container');
                        if (!hintsContainer) {
                            hintsContainer = document.createElement('div');
                            hintsContainer.className = 'hints-container';
                            cardFront.appendChild(hintsContainer);
                        }
                        
                        let hintsHTML = '';
                        if (hints.text_hint_1) {
                            hintsHTML += `<div class="card-hint-text"><i class="fas fa-lightbulb"></i><span>${hints.text_hint_1}</span></div>`;
                        }
                        if (hints.text_hint_2) {
                            hintsHTML += `<div class="card-hint-text"><i class="fas fa-lightbulb"></i><span>${hints.text_hint_2}</span></div>`;
                        }
                        
                        hintsContainer.innerHTML = hintsHTML;
                        cardFront.classList.toggle('has-hints', !!hintsHTML);
                    }
                }
            });

            setTimeout(() => {
                if (cardGrid.scrollHeight > dynamicStage.clientHeight) {
                    dynamicStage.style.alignItems = 'flex-start';
                } else {
                    dynamicStage.style.alignItems = 'center';
                }
            }, 0);
        }

        function showCustomPrompt(title) {
            return new Promise((resolve) => {
                const promptOverlay = document.getElementById('prompt-overlay');
                const promptTitle = document.getElementById('prompt-title');
                const promptInput = document.getElementById('prompt-input');
                const confirmBtn = document.getElementById('prompt-confirm-btn');
                const cancelBtn = document.getElementById('prompt-cancel-btn');

                promptTitle.textContent = title;
                promptInput.value = '';
                promptOverlay.classList.add('active');
                promptInput.focus();

                const confirmHandler = () => {
                    promptOverlay.classList.remove('active');
                    resolve(promptInput.value);
                    removeListeners();
                };

                const cancelHandler = () => {
                    promptOverlay.classList.remove('active');
                    resolve(null);
                    removeListeners();
                };
                
                const keyHandler = (e) => {
                    if (e.key === 'Enter') confirmHandler();
                    if (e.key === 'Escape') cancelHandler();
                };

                const removeListeners = () => {
                    confirmBtn.removeEventListener('click', confirmHandler);
                    cancelBtn.removeEventListener('click', cancelHandler);
                    promptInput.removeEventListener('keydown', keyHandler);
                };

                confirmBtn.addEventListener('click', confirmHandler);
                cancelBtn.addEventListener('click', cancelHandler);
                promptInput.addEventListener('keydown', keyHandler);
            });
        }

        async function addTextHint(cardIndex, hintNumber) {
            if (!isGM) return;
            const hintText = await showCustomPrompt(`Introduce el texto para la Pista ${hintNumber}`);
            if (hintText && hintText.trim() !== "") {
                database.ref(`salas/${salaID}/controls/card_hints/${cardIndex}/text_hint_${hintNumber}`).set(hintText.trim());
            }
        }

        function revelarCarta(index) {
            if (!isGM || !salaID) return;
            const ref = database.ref(`salas/${salaID}/controls/revealed_cards/${index}`);
            ref.once('value', snapshot => {
                ref.set(!snapshot.val());
            });
        }

        function revealSilhouette(cardIndex) {
            if (!isGM) return;
            database.ref(`salas/${salaID}/controls/card_hints/${cardIndex}/show_silhouette`).set(true);
        }

        function controlRevelarTodo(revelar) {
            if (!isGM || !salaID || !currentResults || currentResults.length === 0) return;
            
            if (revelar) {
                const updates = {};
                currentResults.forEach((_, index) => {
                    updates[index] = true;
                });
                database.ref(`salas/${salaID}/controls/revealed_cards`).set(updates);
            } else {
                database.ref(`salas/${salaID}/controls/revealed_cards`).set(null);
            }
        }

        function cerrarSesionGM() {
            if (!isGM || !salaID) {
                location.reload();
                return;
            }
            database.ref('salas/' + salaID).remove();
            location.reload();
        }
    </script>
</body>
</html>